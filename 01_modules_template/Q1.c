Q: Explain linux kernel version
x.y.z
Major.Minor.Patch_fixes
key:"Major Number", "Minor number", "Patch number"
--------------------------------------------------------------------------------------------
Q: List Kernel source directories/organization

--------------------------------------------------------------------------------------------
Q: How linux kernel is compiled - steps
make distclean
make x86_64_defconfig
make menunconfig
make -j4
make modules
make INSTALL_MOD_PATH=/where/to modules_install

key: "distclean, defconfig, menuconfig, make zImage, make modules, modules_install"
--------------------------------------------------------------------------------------------
Q: How kernel is configured
key:make menuconfig, make defconfig - arch/arm/configs folder, make oldconfig

--------------------------------------------------------------------------------------------
Q: what is xconfig
xconfig is a "QT" tool - GUI for configuring the kernel
gconfig is also there - based on GTK+

--------------------------------------------------------------------------------------------
Q: different types of kernel images : vmlinux,vmlinuz,zImage,bzImage,uImage etc

keys: "compressed, un-compressed,u-boot, x86, header"

- kernel Images are based on different types of "compression" used

1. vmlinux
- vmlinux is the kernel in a uncompressed and non-bootable form. 
It’s the intermediate step to producing "vmlinuz"

2. vmlinuz
- vmlinuz is a compressed Linux kernel image file for booting the Linux operating system.
- gzip algorithm is used for compression
- bootloader decompresses the vmlinuz and loads into memory

3. vmlinux.bin
- The vmlinux.bin file is an uncompressed binary image generated during Linux kernel 
source code compilation.
- The file is too big for pratical use

4. zImage
- zimage refers to a distinct compressed kernel image file format. 
- It’s designed for X86-based systems.
- LZ77 compression algorithm is used for compression
- zImage is self-extracting

5. bzImage
- "bz" : Big Zipped - compressed kernel image - has header info for bootloader

6. uImage
- an image file that has a U-Boot wrapper (installed by the mkimage utility) that includes 
the OS type and loader information
- u-boot needs kernel image in the format : uImage
- from u-boot we can run : "bootm" command which decompresses the uImage
- Also now u-boot supports zImage, we can load it using "bootz" command

--------------------------------------------------------------------------------------------
Q: How in-tree modules are compiled - and installed

- make modules, will build the in-tree modules - which are marked as "m", where as "y" will
be part of kernel .o files combined into kernel ELF bin - the one with "y" will not 
be a module -but part of the kernel - and the module is Automatically loaded if marked "y"

- Only "m" marking will make it as a module - which becomes a loadable kernel module - and
we need to load it manually via insmod/modprobe, or auto my adding in etc/modeconf OR it can
be loaded by hotplug - via udev

- make INSTALL_MOD_PATH=/where/to modules_install

- the modules_install will place the modules in /lib/modules/kernel-version/drivers
- and we need to copy the modules to traget

--------------------------------------------------------------------------------------------
Q: kernel compilation for ARM

make ARCH=arm imx_defconfig
make ARCH=arm CROSS_COMPILE=linux-gnueabihf- menuconfig
make ARCH=arm CROSS_COMPILE=linux-gnueabhif- zImage -j4 //or uImage or bzImage
make ARCH=arm CROSS_COMPILE=linux-gnueabhif- modules
make ARCH=arm CROSS_COMPILE=linux-gnueabhif- INSTALL_MOD_PATH=/where/to modules_install

make ARCH=arm CROSS_COMPILE=linux-gbueabhif- dtbs
	OR
make ARCH=arm CROSS_COMPILE=linux-gnueabhif- imx.dtb

--------------------------------------------------------------------------------------------
Q: What is kernel-space and User-space

- Kernel-space is the area of memory where kernel runs and also has privileged access to
all of the memory and restricted instructions like enabling/disabling interrupts etc

- User-space is the area of memory where user-space programs runs - and only has access
to the memory allocated to it - and it runs in un-privileged access
- user-space programs need to use system calls to get access to system resources

- This division of kernel-space and user-space - is mainly controlled using CPU level of
execution
- when moving to kernel-space the CPU level is raised - either when executing INT/Trap
instruction - which puts the CPU to OS level
- When returning from kernel-space to user-space the CPU level is made low - so that
user-level programs cannot execute privileged instructions and also cannot access
other memory areas

--------------------------------------------------------------------------------------------
Q: Explain "depmod" utility - when it is invoked - and module dependency

make modules - will compile the in-tree modules - marked as "m"
make modules_install - will install the compiled modules in /lib/modules/kernel-ver/drivers
- and in a sub step - "depmod" will be run - which will walk through all the modules
in /lib/modules/kernel-ver and generate "modules.dep" and "modules.dep.bin" file - which has
the information of module dependency
- the way it is constructed is by checking the EXPORT_SYMBOL()

- so when a module is being loaded using "modprobe" - it first reads the "modules.dep" file
and then first loads the dependent module and then our module

- "depmod" also generates "modules.alias" file - which has the <device,driver> mapping
- when hot-plug devices are pluged-in, kernel sends vid,pid info to "udev" deamon and
udev sends the vid,pid to "modprobe" - and modprobe scans the "modules.alias" file to
identify the driver/module to be loaded
- and the it scans the "modules.dep" file to find the dependent modules to be loaded
and then loads our module

--------------------------------------------------------------------------------------------
Q: How modules are inserted - explain both insmod and modprobe

insmod module_hello.ko
		OR
modprobe module_hello 

---> Notice here we must not give .ko, as modprobe scan the
modules.dep.bin file to find the dependent modules first and the load our module

- Also module can be removed using :
modprobe -r <module_name> 
- it will unload the dependent modules as well - it not used - in reverse order of loading

modprobe -a <list of modules to be loaded>

--------------------------------------------------------------------------------------------
Q: How to load Modules at boot time

- need to place the module name without .ko, in /etc/modules-load/mymodules.conf
- each line to have 1 module name
- and modprobe will be invoked to load the dpendent modules first and the our module

--------------------------------------------------------------------------------------------
Q: How drivers for hot plug devices are loaded dynamically

- Explained above
--------------------------------------------------------------------------------------------
Q: How to unload modules 

- "rmmod" module_name --> notice here again without .ko
- "modprobe -r" - can also be used to unload a module

- if the module is in-use, the module cannot be unloaded - modules have ref count on the
module usage

--------------------------------------------------------------------------------------------
Q: Can all types of modules be unloaded

- yes we can unload the modules - both in-tree("m") and out-of-tree("m") modules can be 
unloded
- we need to enable it in kernel config, also force remove need to be enabled

- Note : marking it as "y" - is not a module - its Automatically loaded at boot time
and we cannot remove it
--------------------------------------------------------------------------------------------
Q: How to list the modules installed / loaded

"lsmod" can be used to list the installed/loaded modules
- it actually reads from /proc/modules
- And lsmod will only list the dynamically loaded modules
--------------------------------------------------------------------------------------------
Q: Write basic Module / driver skeleton 

static int __init my_init()
{
	pr_info("Top of my_init()\n");
}

static void __exit my_exit()
{
	pr_info("Top of my_exit()\n");
}

module_init(my_init);
module_exit(my_exit);

--------------------------------------------------------------------------------------------
Q: Explain __init, __exit and __init_data

- The __init will place the code in ".init.text" section
- The __exit will place the code in ".exit.text" section

- Once the module is loaded, the memory space occupied by the init() function can be
claimed, either code in section ".init.text"
>> This applies only for built-in('Y') drivers and not for loadable modules('m')-inTree and
out-of-tree - either its not applicable to modules 
- As the section details are part of the final kernel ELF file

- for __exit - in case of built-in('Y') modules - the code is omitted - as it ca not be
unloaded at runtime

--------------------------------------------------------------------------------------------
Q: How __init and __exit matters for in-built and LKMs

- functions marked as __init - will be placed in .init.text section
- And when the module is loaded - the code placed in that ".init.text" section can be claimed
- this can be done - when the code is part of kernel image, with are nothing but driver code
marked as "y" - and registered with module_init()

- And if __exit is marked, the code is ommited - if the function is part of driver marked "y"

- Only in case of driver code - marked as 'y' - this feature is useful - else not
- If its in-tree or out-of-tree module - then it will be marked as 'm' - and __init has no
used - since it not part of kernel ELF - and also __exit is of no use
 
--------------------------------------------------------------------------------------------
Q: Explain MODULE_XXXX macros - license, Author, Desc

MODULE_AUTHOR(), MODULE_LICENSE("GPL") - GPL2 - open-source GPL license
--------------------------------------------------------------------------------------------
Q: Explain how EXPORT_SYMBOL() and GPL works
- The symbols - which can be variables/functionsl, can be made to be exported to rest of the
kernel - by a symbol table - and can be found in /proc/kallsys

- EXPORT_SYMBOL_GPL() - the symbols exported by this - will only be visible to
module which are unser GPL license

--------------------------------------------------------------------------------------------
Q: How Error handling is done in kernel - NULL Pointer Errors

void *ERR_PTR(long error); - ERROR code to Pointer
long IS_ERR(const void *ptr); - Check if the pointer is ERROR or not
long PTR_ERR(const void *ptr); - Convert Pointer to ERROR code

--------------------------------------------------------------------------------------------
Q: Explain likely() and unlikely()
# define likely(x)	__builtin_expect(!!(x), 1)
# define unlikely(x)	__builtin_expect(!!(x), 0)

--------------------------------------------------------------------------------------------
Q: Can printk() be called from ISR - how does printk() work

- Yes prink() can be called from ISR - it will not be blocked
- printk() locks the serial console when priting - if unable to lock, then will write to
buffer - hence can be used in atomic contexts
- But printk() printsm are dependent on the Kenel Log Level

echo <level> > /proc/sys/kernel/printk
>> Log level can be changed
--------------------------------------------------------------------------------------------
Q: How can be pass arguments to module

- First we need to define the module - and then use module_param()
module_param(name, type, perm);

module_param(myint, int, S_IRUGO);
module_param(mystr, charp, S_IRUGO);
module_param_array(myarr, int,NULL, S_IWUSR|S_IRUSR);

- Args can be passed using:
insmod hellomodule-params.ko mystring="packtpub" myint=15 myArray=1,2,3
--------------------------------------------------------------------------------------------
Q: How can we change the variable values at runtime of the kernel module

- This can be done, by having a callback function registered via : "module_param_cb()"
- We need to define the set() and get() functions
- It will be exposed in : /sys/module/hello_world_module/parameters/valueETX
--------------------------------------------------------------------------------------------
Q: How are kernel modules built, in-tree and out-of-tree compilation steps

- In-the-Kernel-Tree
- Two files will need modification : Makefile and Kconfig

kconfig:
config MY_DRIVER_CODE
	tristate "Info"
	default m
	help
		Say Y for compiling part of the kernel image
		Say m for compiling it as a kernel module - which is compiled as LKM - make modules

Makefile:
obj-$(CONFIG_MY_DRIVER_CODE)	+= mychardriver.o

- We can set the CONFIG_MY_DRIVER_CODE to "m,n,y" either from menuconfig or directly in
defconfig file placed in arch/arm/configs/

CONFIG_MY_DRIVER_CODE=m
CONFIG_MY_DRIVER_CODE=y

---------------
- Out of tree compile:

obj-m := helloworld.o
KERNELDIR ?= /lib/modules/$(shell uname -r)/build
all default: modules
install: modules_install
modules modules_install help clean:
$(MAKE) -C $(KERNELDIR) M=$(shell pwd) $@

- At minimum we will need kernel headers
--------------------------------------------------------------------------------------------

Q: Explain container_of() Macro

- container_of(pointer, big_structure_type, name_of_member)

struct car
{
	int number;
	int model;
	struct list_head car_list;
};

- Using any of the member address - we can get to the big/man structure address

struct car baleno;

struct car *my_car = container_of(&baleno.model, struct car, model);
(&baleno.model) - offset_of(struct car, model)

>> Here the model is at offset of 4-bytes, so addr-4 will get us to top the structure

--------------------------------------------------------------------------------------------
Q: How are linked list implemented in the kernel - what are the APIs

struct list_head
{
	struct list_head *next;
	struct list_head *prev;
};

STATIC_Creation:
static LIST_HEAD(my_head);

DYNAMIC:
struct list_head *my_head = (struct list_head *)kmalloc(sizeof(struct list_head), GFP_KERNEL);
INIT_LIST_HEAD(my_head);

struct car
{
	int number;
	int model;
	struct list_head car_list;
};

struct car *my_car = (struct car*)kmalloc(sizeof(struct car), GFP_KERNEL);
INIT_LIST_HEAD(&my_car->car_list);

list_add(&my_car->car_list, my_head);
list_add(&his_car->car_list, my_head);

list_add_tail(&my_car->car_list, my_head);

list_del(&my_car->car_list, my_head);
--------------------------------------------------------------------------------------------
Q: Write a module - creating a linked list - and Also traverse the list

list_for_each_entry(pointer_to_big_struct, HEAD, member_name_of_list_in_big);

list_for_each_entry(tmp_car, my_head, car_list)
{
	model = tmp_car->model;
}

--------------------------------------------------------------------------------------------
Q: Explain how can we use Wait Queues - write a simple module

- Note we do not create "Wait Queues" ourselves

--------------------------------------------------------------------------------------------
Q: Which are 2 catagories of Time in kernel - and Explain

--------------------------------------------------------------------------------------------
Q: Which are the 2 kernel Timers

--------------------------------------------------------------------------------------------
Q: Explain kernel standard timers - and its APIs - how its used in a module

--------------------------------------------------------------------------------------------
Q: Explain HR Timers - how is it different from standard timers

--------------------------------------------------------------------------------------------
Q: What is Dynamic Tick / Tickless Timer in kernel 

--------------------------------------------------------------------------------------------
Q: How can be sleep/delay in Atomic Contexts

--------------------------------------------------------------------------------------------
Q: Which are all the kernel Locking Mechanisms

--------------------------------------------------------------------------------------------
Q: Explain Mutex lock in kernel - with an example

--------------------------------------------------------------------------------------------
Q: Explain spin locks and its variants - with an example

--------------------------------------------------------------------------------------------
Q: Difference between Mutex and Spin locks

--------------------------------------------------------------------------------------------
Q: Which are the Work Deffering Mechanisms

--------------------------------------------------------------------------------------------
Q: Explain SoftIRQ - how its used - and how can we used softIRQ for a module

--------------------------------------------------------------------------------------------
Q: Explain Tasklets - How its used

--------------------------------------------------------------------------------------------
Q: Difference between Tasklets and SoftIRQ

--------------------------------------------------------------------------------------------
Q: Explain Work Queues

--------------------------------------------------------------------------------------------
Q: What is the difference between Shared Work Queue and Dedicated work Queues

--------------------------------------------------------------------------------------------
Q: How can be register a ISR with the kernel

--------------------------------------------------------------------------------------------
Q: Explain bottom-half - how many ways we can have bottom halves

--------------------------------------------------------------------------------------------
Q: Explain Threaded IRQ

--------------------------------------------------------------------------------------------
Q: Explain IRQ flags

--------------------------------------------------------------------------------------------
Q: What are kernel Threads and how can we use it in a module

--------------------------------------------------------------------------------------------
###########################################################################################

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------


###########################################################################################


###########################################################################################

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------


###########################################################################################


###########################################################################################

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------


###########################################################################################


###########################################################################################

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------


###########################################################################################


###########################################################################################

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------


###########################################################################################


###########################################################################################

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------


###########################################################################################


###########################################################################################

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------


###########################################################################################


###########################################################################################

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------


###########################################################################################


###########################################################################################

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------


###########################################################################################


###########################################################################################

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------


###########################################################################################


###########################################################################################

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------


###########################################################################################



